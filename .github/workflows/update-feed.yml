name: Update Podcast Feed

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install feedparser

      - name: Generate and update feed.xml
        run: |
          python - <<'EOF'
          import feedparser
          from xml.etree.ElementTree import Element, SubElement, Comment, tostring, ElementTree
          from xml.dom import minidom
          import datetime

          # Your Anchor RSS
          anchor_rss = 'https://anchor.fm/s/10c3f3eac/podcast/rss'
          feed = feedparser.parse(anchor_rss)

          # Root
          rss = Element('rss', {'version': '2.0'})
          rss.set('xmlns:itunes', 'http://www.itunes.com/dtds/podcast-1.0.dtd')
          rss.set('xmlns:atom', 'http://www.w3.org/2005/Atom')

          channel = SubElement(rss, 'channel')

          # Channel metadata
          titles = ['title', 'link', 'description', 'itunes:author', 'language']
          values = [
            'The Reika Dynasty Public Broadcast',
            'https://grimsythe.github.io/The-Reika-Dynasty-Public-Broadcast/',
            'Stay vigilant. Stay graceful. And pleaseâ€”mind your posture.',
            'Setsumi No Kami',
            'en'
          ]
          for t, v in zip(titles, values):
            SubElement(channel, t).text = v

          SubElement(channel, 'atom:link', {
            'href': 'https://grimsythe.github.io/The-Reika-Dynasty-Public-Broadcast/feed.xml',
            'rel': 'self',
            'type': 'application/rss+xml'
          })

          SubElement(channel, 'itunes:image', {'href': 'https://pbs.twimg.com/profile_images/1995353298837061632/u1DJU9sY.jpg'})

          # Categories
          for cat in ['Fiction', 'Science Fiction']:
            SubElement(channel, 'itunes:category', {'text': cat})

          SubElement(channel, 'itunes:explicit').text = 'no'

          owner = SubElement(channel, 'itunes:owner')
          SubElement(owner, 'itunes:name').text = 'Alex Waters'
          SubElement(owner, 'itunes:email').text = 'your-email@example.com'  # <-- CHANGE TO YOUR EMAIL

          # Episodes (all of them, oldest first)
          for entry in reversed(feed.entries):
            item = SubElement(channel, 'item')
            SubElement(item, 'title').text = entry.title
            SubElement(item, 'link').text = entry.link
            pub_date = datetime.datetime.strptime(entry.published, '%a, %d %b %Y %H:%M:%S %Z').strftime('%Y-%m-%d')
            SubElement(item, 'guid', {'isPermaLink': 'false'}).text = f"reika-{pub_date}"
            SubElement(item, 'pubDate').text = entry.published

            if entry.enclosures:
              enc = entry.enclosures[0]
              SubElement(item, 'enclosure', {'url': enc.href, 'length': enc.get('length', '0'), 'type': enc.type})

            if hasattr(entry, 'itunes_duration'):
              SubElement(item, 'itunes:duration').text = entry.itunes_duration

            desc = SubElement(item, 'description')
            desc.text = f"<![CDATA[{entry.summary}]]>"

          # Pretty print
          rough = tostring(rss, 'unicode')
          reparsed = minidom.parseString(rough)
          pretty = repar
